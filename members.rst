#############################################
会员留存问题分析
#############################################
:Auther: Xuemei Wang
:Created: 2019-03-20
:Modified: 2019-06-12

.. contents:: :depth: 1

针对会员留存问题，我们将从以下三个方面来组织本文：

1. 获取训练集，这部分主要解决的问题是：

    * 获取典型的，干净的数据.

2. 数据分析，这部分主要解决的问题是为人服务的：

    * 我们能从数据中得到什么结论.
    * 这些结论如何帮助我们做决策.

3. 机器学习，模型预测，这部分主要解决的问题：

    * 预测用户分类.
    * 结合2，对相应的用户做个性化的政策/推送.
     
训练数据
============================================

数据定位
--------------------------------------------

这个问题（不同于分析/引导非会员用户成为会员）针对的已经是会员的情况下，分析留存问题。为保证数据的典型性，这里提取主动选择续费或终止会员作为正负样本.

    * 正样本：有过会员体会，主动会员续费.
    * 负样本：自动续费用户，主动终止会员.

这里暂不考虑由于自动续费而继续成为会员的人群, 或非自动续费用户不再续费，原因是这是非典型数据，惰性/习惯等非主观因素影响较大.

数据描述
--------------------------------------------

我们的数据:

    * 取自2019年3月10号（包括）之前.
    * 清洗之后，正样本21322个，负样本45667个.

数据分析
============================================

1. 我们主要在两个纬度上对数据分析:

    * 横向上：正负样本.
    * 纵向上：时间纬度，成为会员前后(一个月).

2. 影响因素上主要是从会员留存对因素主要从会员权益上，原因是这些才能用于我们的决策:
   
    * 智能训练计划.
    * 商城相关，例如，优惠券, 会员价, keepland, etc.

3. 对于用户的内禀属性(例如，用户画像)我们在数据分析层面不考虑，而留在模型预测再作为输入特征，原因同上，这些属性对于我们策略调整上没有帮助.

4. 在这一部分，为了便于说明问题，我们采用归一化正负样本的数量.

商城相关
--------------------------------------------

.. image:: images/consumption.png
  :height: 300
  :width: 500

描述：成为会员前后用户在商城的消费.

    1. 在成为会员之前，用户在商城的消费行为，已经有明显的区别，即P的用户，要比N的用户更愿意消费 > 2.
    2. 成为会员，会促进用户在商城的消费。对于N的用户更明显, 对P，N分别增长为原来的：1.63, 2.43 倍.

结论：P内禀消费用户(占比高，下同)，N刺激消费用户.

.. image:: images/coupon.png
  :height: 300
  :width: 500

描述：在是会员期间是否使用优惠券.

    1. coupon(优惠券，会员价，keepland优惠，etc.)在N，P中的使用率相当.

结论：会员在商城中的有优惠的这个事情本身(描述)，会促进商城的消费，而不是由于会员用了优惠这个事件，即，会员优惠，对商城带来的收益是正面的，即时不考虑成本价销售价之间的差别。(更精确的描述是把价格考虑进来，但这样但比例足以说明问题。)
    
策略：有策略地提醒用户有优惠券可用，例如，推送提醒，尤其是N类用户.

.. image:: images/coupon_type.png
  :height: 300
  :width: 500

(keepland 部分加入横纵向比较，补充)

问题：同期商城用户在会员中的占比不高，可能典型性不强，可以加大商城用户时间窗口.

运动相关
--------------------------------------------

.. image:: images/tc_in_member.png
  :height: 300
  :width: 500

描述：成为会员前后用户在的运动情况

    1. 在成为会员之前，用户的运动行为已经有的区别，并不太显著，P:N = 78:69 .
    2. 成为会员，会促进进用户运动。对P，N分别增长为原来的：1.12, 1.25倍.

.. image:: images/suit_in_member.png
  :height: 300
  :width: 500

描述：会员期间，智能训练计划联系情况与整体运动对比.


.. image:: images/feel_in_suit.png
  :height: 300
  :width: 500

.. image:: images/feel_one_month_ago.png
  :height: 300
  :width: 500

.. image:: images/feel_in_tc.png
  :height: 300
  :width: 500

.. image:: images/training_times.png
  :height: 300
  :width: 500


.. image:: images/achievement.png
  :height: 300
  :width: 500

.. image:: images/tc_distribution.png
  :height: 400
  :width: 500

结论: 
    1. Ns are yelling. Please Listen!
    2. Difficulty is the problem? Hard to say... or No.
    3. 会员的内禀属性是重要的.
    4. 训练完成度差别不大，但是Ns 弱大于 Ps (maybe mindset matters!)
    
策略：
    1. 要让用户（尤其是N）感受到我们听到并重视他们到反馈，在我们短期内没有办法及时解决到情况下，给以安抚，给予一定的一次性无成本性质的优惠，例如，免费练习付费课程一次,（应以课程为主，运动会让人分泌内多酚，倾向于越坚持越开心，而消费容易遗忘）
    2. 对于练习次数较少的用户，要提醒，鼓励用户坚持(推送?)，这是正反馈，越坚持就越坚持，鼓励非常重要！这是一件好事.

从数据可以看出用户的内禀属性很大成都上决定了用户的去留，我们的策略是，利用用户的内禀属性（例如，用户画像部分）和成为会员前一段时间和会员期间的行为，对用户进行预测，正负走向，有针对性采取相应策略。我们将在下一章来对用户进行训练和预测.

注意: 
    1. 请不要错误地利用以上信息采用激进策略，任何损害于用户原有利益地变动，或过多干预，都会带来用户心理上地反感。所以我们应该有针对性的用户进行政策调整，减少对于稳定用户不必要的扰动。
    2. 对于预测可能为P的用户应该，应该尽可能保证稳定。
    3. 对于预测可能为N的用户应该，应该站在用户立场上，让其感到我们的真诚，有提醒和鼓励甚至一定程度的奖励，但不不是干预。这是一批愿意发声的用户，应该尽量留住他们。

机器学习
============================================

这一部分分两个模型进行训练，模型的区别在于训练集中正样本的选择：

1. 模型1，正样本选择有过会员经验后主动选择成为会员的
2. 模型2，正样本选择目前是会员的在一个月之前依然是会员的

两种模型中(不可避免)存在模型数据的bias, 模型1正样本选择严苛，模型2正样本选择宽松，所以以0.5为分界线的话，模型1，预测负样本较多，模型2，预测正样本较多。
具体选择时根据我们的需求进行边界划分


特征选择和模型
--------------------------------------------

1. 47维：

   * from user_profile: 
   
     * gender,
     * age,
     * bmi

   * from suit data:

     * duration(as a member),
     * difficult_ratio (feedback of difficult/training), 
     * medium_ratio, 
     * easy_ratio, 
     * training_ration (training / min(30, duration))
     * training (times)
     * days (TODO: duplication, min(30, duration))

   * from device

     * apple, huawei, appo, vivo, mi, meizu, samsung, gionee, oneplus, lemobile, smatisan, nubia, meitu, tsz, letv, lenovo

   * from training history

     * five types: running, hiking, yoga, training, cycling
     * one month seperated by week

2. Model: Xgboost

3. Metrics:

+---------+---------+---------+
|         | 1       | 0       |
+=========+=========+=========+
| ^1      | TP      | FP      |
+---------+---------+---------+
| ^0      | FN      | TN      |
+---------+---------+---------+

训练结果分析
--------------------------------------------

05-19
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

* Class 1: Precision = 0.8378778897451097
* Class 1: Recall = 0.957169459962756
* Class 0: Precision = 0.9285915890488287
* Class 0: Recall = 0.7504562043795621
* AUC = 0.8832347393969693

+---------+---------+---------+
|         | 1       | 0       |
+=========+=========+=========+
| ^1      | 5654    | 1094    |
+---------+---------+---------+
| ^0      | 253     | 3290    |
+---------+---------+---------+

05-18
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

* Class 1: Precision = 0.841740412979351
* Class 1: Recall = 0.9494260522375645
* Class 0: Precision = 0.9178156258448229
* Class 0: Recall = 0.759847806624888
* AUC = 0.8797780194120869

+---------+---------+---------+
|         | 1       | 0       |
+=========+=========+=========+
| ^1      | 5707    | 1073    |
+---------+---------+---------+
| ^0      | 304     | 3395    |
+---------+---------+---------+


05-17
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

* Class 1: Precision = 0.8446376811594203
* Class 1: Recall = 0.954471012119227
* Class 0: Precision = 0.9251077586206896
* Class 0: Recall = 0.7620949844651576
* AUC = 0.8848727198900549

+---------+---------+---------+
|         | 1       | 0       |
+=========+=========+=========+
| ^1      | 5828    | 1072    |
+---------+---------+---------+
| ^0      | 278     | 3434    |
+---------+---------+---------+

图示
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. image:: images/all_features.png
  :height: 700
  :width: 800

.. image:: images/member_relations.png
  :height: 700
  :width: 800


预测分析
--------------------------------------------

模型1

.. image:: images/model1.png
  :height: 200
  :width: 500

模型2

.. image:: images/model2.png
  :height: 200
  :width: 500

综合考虑 

1. 流失率占比0.43,
2. 高的流失准去率,
3. 尽量小的波动,

之后哪个模型效果更好些，可以在两个算法之间做做AB测试，目前结果采用模型2给出的结果。
